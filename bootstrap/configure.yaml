---
- name: Cluster Installation
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - vars/config.yaml
    - vars/addons.yaml
  tasks:
    - name: Get absolute path to this Git repository # noqa: command-instead-of-module
      ansible.builtin.command: git rev-parse --show-toplevel
      changed_when: false
      check_mode: false
      register: repository
      failed_when: repository.rc != 0

    - name: Set facts
      ansible.builtin.set_fact:
        repository_path: "{{ repository.stdout }}"

    - name: Override kubeapi address when there is a single master node and no address is defined
      when: bootstrap_nodes.master | length == 1 and not bootstrap_kubeapi_addr
      ansible.builtin.set_fact:
        bootstrap_kube_vip_enabled: false
        bootstrap_kubeapi_addr: "{{ bootstrap_nodes.master[0].address }}"

    - name: Verify configuration
      ansible.builtin.include_tasks: tasks/validation/main.yaml

    - name: Template SOPS configuration # noqa: no-changed-when
      ansible.builtin.shell:
        cmd: >
          makejinja
          --input "{{ repository_path }}/bootstrap/templates/.sops.yaml.j2"
          --output "{{ repository_path }}/.sops.yaml"
          --data "{{ repository_path }}/bootstrap/vars/config.yaml"
          --jinja-suffix ".j2" --quiet --force

    - name: Template k0s configuration # noqa: no-changed-when
      when: bootstrap_distribution == "k0s"
      ansible.builtin.shell:
        cmd: >
          makejinja
          --input "{{ repository_path }}/bootstrap/templates/k0s/k0s-config.yaml.j2"
          --output "{{ repository_path }}/k0s-config.yaml"
          --data-var "bootstrap_kube_vip_enabled={{ bootstrap_kube_vip_enabled }}"
          --data-var "bootstrap_kubeapi_addr={{ bootstrap_kubeapi_addr }}"
          --data "{{ repository_path }}/bootstrap/vars/config.yaml"
          --data "{{ repository_path }}/bootstrap/vars/addons.yaml"
          --jinja-suffix ".j2" --quiet --force

    - name: Template Ansible configuration # noqa: no-changed-when
      when: bootstrap_distribution == "k0s" or bootstrap_distribution == "k3s"
      ansible.builtin.shell:
        cmd: >
          makejinja
          --input "{{ repository_path }}/bootstrap/templates/ansible"
          --output "{{ repository_path }}/ansible"
          --data-var "bootstrap_kube_vip_enabled={{ bootstrap_kube_vip_enabled }}"
          --data-var "bootstrap_kubeapi_addr={{ bootstrap_kubeapi_addr }}"
          --data "{{ repository_path }}/bootstrap/vars/config.yaml"
          --data "{{ repository_path }}/bootstrap/vars/addons.yaml"
          --jinja-suffix ".j2" --quiet --force

    - name: Template Kubernetes configuration # noqa: no-changed-when
      ansible.builtin.shell:
        cmd: >
          makejinja
          --input "{{ repository_path }}/bootstrap/templates/kubernetes"
          --output "{{ repository_path }}/kubernetes"
          --data-var "bootstrap_kube_vip_enabled={{ bootstrap_kube_vip_enabled }}"
          --data-var "bootstrap_kubeapi_addr={{ bootstrap_kubeapi_addr }}"
          --data "{{ repository_path }}/bootstrap/vars/config.yaml"
          --data "{{ repository_path }}/bootstrap/vars/addons.yaml"
          --jinja-suffix ".j2" --quiet --force
